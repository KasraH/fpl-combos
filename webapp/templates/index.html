<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FPL Player Combination Analyzer</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      }

      .main-container {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px);
        margin-top: 2rem;
        margin-bottom: 2rem;
      }

      .header {
        background: linear-gradient(135deg, #38ef7d 0%, #11998e 100%);
        color: white;
        padding: 2rem;
        border-radius: 15px 15px 0 0;
      }

      .step-card {
        border: none;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        transition: transform 0.3s ease;
        margin-bottom: 1.5rem;
      }

      .step-card:hover {
        transform: translateY(-5px);
      }

      .step-number {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-right: 1rem;
      }

      .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 25px;
        padding: 10px 25px;
        transition: transform 0.3s ease;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
      }

      .btn-success {
        background: linear-gradient(135deg, #38ef7d 0%, #11998e 100%);
        border: none;
        border-radius: 25px;
        padding: 10px 25px;
      }

      .player-tag {
        background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
        color: #333;
        padding: 5px 15px;
        border-radius: 20px;
        margin: 3px;
        display: inline-block;
        font-size: 0.9rem;
      }

      .results-card {
        background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        border-radius: 10px;
        padding: 1.5rem;
        margin-top: 1rem;
      }

      .manager-card {
        background: white;
        border-radius: 8px;
        padding: 1rem;
        margin: 0.5rem 0;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .loading {
        display: none;
      }

      .alert {
        border-radius: 10px;
        border: none;
      }

      .progress {
        height: 8px;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.3);
      }

      .progress-bar {
        border-radius: 10px;
      }

      .cache-info {
        background: rgba(255, 255, 255, 0.8);
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="main-container">
        <!-- Header -->
        <div class="header text-center">
          <h1>
            <i class="fas fa-futbol"></i>
            FPL Player Combination Analyzer
          </h1>
          <p class="mb-0">
            Find which managers in your league have specific player combinations
          </p>
        </div>

        <div class="p-4">
          <!-- League Status -->
          <div id="leagueStatus" class="alert alert-info" style="display: none">
            <i class="fas fa-info-circle"></i>
            <span id="leagueStatusText"></span>
          </div>

          <!-- Step 1: Load League -->
          <div class="step-card card">
            <div class="card-body">
              <div class="d-flex align-items-center mb-3">
                <div class="step-number">1</div>
                <h5 class="mb-0">Load League Data</h5>
              </div>

              <div class="row">
                <div class="col-md-8">
                  <div class="input-group">
                    <span class="input-group-text">
                      <i class="fas fa-trophy"></i>
                    </span>
                    <input
                      type="number"
                      id="leagueId"
                      class="form-control"
                      placeholder="Enter FPL League ID"
                      min="1"
                    />
                    <button class="btn btn-primary" onclick="loadLeague()">
                      <span id="loadLeagueText">Load League</span>
                      <span
                        id="loadLeagueSpinner"
                        class="loading spinner-border spinner-border-sm ms-2"
                      ></span>
                    </button>
                  </div>
                  <small class="text-muted">
                    Find your league ID in the FPL website URL (e.g.,
                    fantasy.premierleague.com/leagues/123456/standings/c)
                  </small>
                </div>
              </div>

              <!-- Progress Bar -->
              <div id="loadingProgress" class="mt-3" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <small id="progressMessage" class="text-muted">Loading...</small>
                  <small id="progressPercent" class="text-muted">0%</small>
                </div>
                <div class="progress" style="height: 8px;">
                  <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                       role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                  </div>
                </div>
                <div id="progressDetails" class="mt-1" style="display: none;">
                  <small class="text-muted">
                    <span id="fetchedCount">0</span> / <span id="totalCount">0</span> managers fetched
                  </small>
                </div>
              </div>
            </div>
          </div>

          <!-- Step 2: Select Players -->
          <div class="step-card card">
            <div class="card-body">
              <div class="d-flex align-items-center mb-3">
                <div class="step-number">2</div>
                <h5 class="mb-0">Select Players</h5>
              </div>

              <div class="row">
                <div class="col-md-8">
                  <div class="input-group">
                    <span class="input-group-text">
                      <i class="fas fa-search"></i>
                    </span>
                    <input
                      type="text"
                      id="playerSearch"
                      class="form-control"
                      placeholder="Search for a player (e.g., Salah, Haaland)"
                    />
                  </div>

                  <!-- Player suggestions -->
                  <div
                    id="playerSuggestions"
                    class="list-group mt-2"
                    style="display: none; position: relative; z-index: 1000"
                  ></div>

                  <!-- Selected players -->
                  <div id="selectedPlayers" class="mt-3">
                    <h6>Selected Players:</h6>
                    <div id="playerTags"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Step 3: Analyze -->
          <div class="step-card card">
            <div class="card-body">
              <div class="d-flex align-items-center mb-3">
                <div class="step-number">3</div>
                <h5 class="mb-0">Analyze Combinations</h5>
              </div>

              <button
                class="btn btn-success btn-lg"
                onclick="analyzeCombination()"
                disabled
                id="analyzeBtn"
              >
                <i class="fas fa-chart-line"></i>
                Find Managers with These Players
                <span
                  id="analyzeSpinner"
                  class="loading spinner-border spinner-border-sm ms-2"
                ></span>
              </button>
            </div>
          </div>

          <!-- Results -->
          <div id="results" style="display: none">
            <div class="results-card">
              <h4>
                <i class="fas fa-chart-bar"></i>
                Analysis Results
              </h4>
              <div id="resultsSummary"></div>
              <div id="managersGrid" class="mt-3"></div>
            </div>
          </div>

          <!-- Cache Information -->
          <div id="cacheInfo" class="cache-info mt-4" style="display: none">
            <h6>
              <i class="fas fa-database"></i>
              Cache Information
            </h6>
            <div id="cacheList"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      let selectedPlayers = []
      let leagueLoaded = false

      // Load league data with progress
      function loadLeague() {
        const leagueId = document.getElementById('leagueId').value.trim()

        if (!leagueId) {
          alert('Please enter a league ID')
          return
        }

        const loadButton = document.querySelector('#loadLeagueText')
        const spinner = document.getElementById('loadLeagueSpinner')
        const progressDiv = document.getElementById('loadingProgress')
        const progressBar = document.getElementById('progressBar')
        const progressMessage = document.getElementById('progressMessage')
        const progressPercent = document.getElementById('progressPercent')
        const progressDetails = document.getElementById('progressDetails')
        const fetchedCount = document.getElementById('fetchedCount')
        const totalCount = document.getElementById('totalCount')

        // Reset UI
        loadButton.textContent = 'Loading...'
        spinner.style.display = 'inline-block'
        progressDiv.style.display = 'block'
        progressBar.style.width = '0%'
        progressBar.setAttribute('aria-valuenow', '0')
        progressMessage.textContent = 'Starting...'
        progressPercent.textContent = '0%'
        progressDetails.style.display = 'none'

        // Create EventSource for progress updates
        const eventSource = new EventSource(`/api/load_league_progress/${leagueId}`)

        eventSource.onmessage = function(event) {
          try {
            const data = JSON.parse(event.data)
            
            switch(data.status) {
              case 'initializing':
              case 'progress':
                progressMessage.textContent = data.message
                break
                
              case 'fetching':
                progressMessage.textContent = data.message
                progressPercent.textContent = `${data.progress}%`
                progressBar.style.width = `${data.progress}%`
                progressBar.setAttribute('aria-valuenow', data.progress)
                
                // Show detailed progress
                progressDetails.style.display = 'block'
                fetchedCount.textContent = data.fetched
                totalCount.textContent = data.total
                break
                
              case 'complete':
                progressMessage.textContent = data.message
                progressPercent.textContent = '100%'
                progressBar.style.width = '100%'
                progressBar.setAttribute('aria-valuenow', '100')
                progressBar.classList.remove('progress-bar-animated')
                progressBar.classList.add('bg-success')
                
                // Update status
                leagueLoaded = true
                showLeagueStatus(
                  `✅ ${data.message}`,
                  'success'
                )
                updateAnalyzeButton()
                loadCacheInfo()
                
                // Hide progress after 3 seconds
                setTimeout(() => {
                  progressDiv.style.display = 'none'
                }, 3000)
                
                eventSource.close()
                break
                
              case 'error':
                showLeagueStatus(`❌ ${data.message}`, 'danger')
                progressDiv.style.display = 'none'
                eventSource.close()
                break
            }
          } catch (error) {
            console.error('Error parsing progress data:', error)
          }
        }

        eventSource.onerror = function(error) {
          console.error('EventSource failed:', error)
          showLeagueStatus('❌ Connection error while loading league', 'danger')
          progressDiv.style.display = 'none'
          eventSource.close()
        }

        // Always reset button after some time
        setTimeout(() => {
          loadButton.textContent = 'Load League'
          spinner.style.display = 'none'
        }, 1000)
      }

      // Show league status
      function showLeagueStatus(message, type) {
        const status = document.getElementById('leagueStatus')
        const statusText = document.getElementById('leagueStatusText')

        status.className = `alert alert-${type}`
        statusText.textContent = message
        status.style.display = 'block'
      }

      // Search for players
      let searchTimeout
      document
        .getElementById('playerSearch')
        .addEventListener('input', function () {
          clearTimeout(searchTimeout)
          const query = this.value.trim()

          if (query.length < 2) {
            document.getElementById('playerSuggestions').style.display = 'none'
            return
          }

          searchTimeout = setTimeout(() => searchPlayers(query), 300)
        })

      async function searchPlayers(query) {
        try {
          const response = await fetch('/api/search_players', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ query: query }),
          })

          const data = await response.json()

          if (data.players) {
            displayPlayerSuggestions(data.players)
          }
        } catch (error) {
          console.error('Error searching players:', error)
        }
      }

      // Display player suggestions
      function displayPlayerSuggestions(players) {
        const suggestions = document.getElementById('playerSuggestions')

        if (players.length === 0) {
          suggestions.style.display = 'none'
          return
        }

        suggestions.innerHTML = ''
        players.forEach(player => {
          const item = document.createElement('a')
          item.className = 'list-group-item list-group-item-action'
          item.href = '#'
          item.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${player.name}</strong> 
                            <small class="text-muted">(${player.full_name})</small>
                        </div>
                        <small class="text-muted">${player.team} - ${player.position}</small>
                    </div>
                `

          item.addEventListener('click', e => {
            e.preventDefault()
            addPlayer(player.name)
            suggestions.style.display = 'none'
            document.getElementById('playerSearch').value = ''
          })

          suggestions.appendChild(item)
        })

        suggestions.style.display = 'block'
      }

      // Add player to selection
      function addPlayer(playerName) {
        if (!selectedPlayers.includes(playerName)) {
          selectedPlayers.push(playerName)
          updatePlayerTags()
          updateAnalyzeButton()
        }
      }

      // Remove player from selection
      function removePlayer(playerName) {
        selectedPlayers = selectedPlayers.filter(p => p !== playerName)
        updatePlayerTags()
        updateAnalyzeButton()
      }

      // Update player tags display
      function updatePlayerTags() {
        const container = document.getElementById('playerTags')

        if (selectedPlayers.length === 0) {
          container.innerHTML =
            '<em class="text-muted">No players selected</em>'
          return
        }

        container.innerHTML = selectedPlayers
          .map(
            player =>
              `<span class="player-tag">
                    ${player} 
                    <i class="fas fa-times ms-1" style="cursor: pointer;" onclick="removePlayer('${player}')"></i>
                </span>`
          )
          .join('')
      }

      // Update analyze button state
      function updateAnalyzeButton() {
        const btn = document.getElementById('analyzeBtn')
        btn.disabled = !leagueLoaded || selectedPlayers.length === 0
      }

      // Analyze combination
      async function analyzeCombination() {
        if (selectedPlayers.length === 0) {
          alert('Please select at least one player')
          return
        }

        const btn = document.getElementById('analyzeBtn')
        const spinner = document.getElementById('analyzeSpinner')

        btn.disabled = true
        spinner.style.display = 'inline-block'

        try {
          const response = await fetch('/api/analyze_combination', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ player_names: selectedPlayers }),
          })

          const data = await response.json()

          if (data.success) {
            displayResults(data)
          } else {
            alert(`Error: ${data.error}`)
          }
        } catch (error) {
          alert(`Error: ${error.message}`)
        } finally {
          btn.disabled = false
          spinner.style.display = 'none'
          updateAnalyzeButton()
        }
      }

      // Display analysis results
      function displayResults(data) {
        const resultsDiv = document.getElementById('results')
        const summaryDiv = document.getElementById('resultsSummary')
        const managersDiv = document.getElementById('managersGrid')

        // Summary
        summaryDiv.innerHTML = `
                <div class="row text-center">
                    <div class="col-md-3">
                        <h3 class="text-primary">${data.matching_managers}</h3>
                        <p class="mb-0">Matching Managers</p>
                    </div>
                    <div class="col-md-3">
                        <h3 class="text-info">${data.total_managers}</h3>
                        <p class="mb-0">Total Managers</p>
                    </div>
                    <div class="col-md-3">
                        <h3 class="text-success">${data.percentage.toFixed(
                          1
                        )}%</h3>
                        <p class="mb-0">Have Combination</p>
                    </div>
                    <div class="col-md-3">
                        <h3 class="text-warning">${selectedPlayers.length}</h3>
                        <p class="mb-0">Players Selected</p>
                    </div>
                </div>
            `

        // Managers
        if (data.results.length > 0) {
          managersDiv.innerHTML = `
                    <h5 class="mt-4">Managers with this combination:</h5>
                    ${data.results
                      .map(
                        manager => `
                        <div class="manager-card">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>${manager.manager_name}</strong>
                                    <br>
                                    <small class="text-muted">${
                                      manager.team_name
                                    }</small>
                                    <br>
                                    <small class="text-info">ID: ${
                                      manager.manager_id
                                    }</small>
                                </div>
                                <div class="text-end">
                                    <div><strong>${
                                      manager.total_points || 0
                                    }</strong> total points</div>
                                    <div><span class="badge bg-success">${
                                      manager.gw_points || 'N/A'
                                    }</span> GW points</div>
                                    <a href="${
                                      manager.fpl_url
                                    }" target="_blank" class="btn btn-sm btn-outline-primary mt-1">
                                        <i class="fas fa-external-link-alt"></i> View Team
                                    </a>
                                </div>
                            </div>
                        </div>
                    `
                      )
                      .join('')}
                `
        } else {
          managersDiv.innerHTML =
            '<div class="alert alert-warning">No managers found with this combination.</div>'
        }

        resultsDiv.style.display = 'block'
        resultsDiv.scrollIntoView({ behavior: 'smooth' })
      }

      // Load cache information
      async function loadCacheInfo() {
        try {
          const response = await fetch('/api/cache_info')
          const data = await response.json()

          if (data.cache_files && data.cache_files.length > 0) {
            const cacheDiv = document.getElementById('cacheInfo')
            const listDiv = document.getElementById('cacheList')

            listDiv.innerHTML = data.cache_files
              .map(
                cache => `
                        <small class="d-block">
                            League ${cache.league_id} (GW ${cache.gameweek}) - 
                            ${cache.manager_count} managers - 
                            ${new Date(cache.cached_at).toLocaleDateString()}
                        </small>
                    `
              )
              .join('')

            cacheDiv.style.display = 'block'
          }
        } catch (error) {
          console.error('Error loading cache info:', error)
        }
      }

      // Hide suggestions when clicking outside
      document.addEventListener('click', function (e) {
        if (
          !e.target.closest('#playerSearch') &&
          !e.target.closest('#playerSuggestions')
        ) {
          document.getElementById('playerSuggestions').style.display = 'none'
        }
      })

      // Initialize
      updatePlayerTags()
      updateAnalyzeButton()
      loadCacheInfo()

      // Allow Enter key to load league
      document
        .getElementById('leagueId')
        .addEventListener('keypress', function (e) {
          if (e.key === 'Enter') {
            loadLeague()
          }
        })
    </script>
  </body>
</html>
